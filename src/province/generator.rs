// src/province/generator.rs
//! –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–∏–Ω—Ü–∏–π –º–∏—Ä–∞
//!
//! –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≤–∏–Ω—Ü–∏–π:
//! 1. **–†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å–µ–º—è–Ω** ‚Äî –≤—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è —Å—É—Ö–æ–ø—É—Ç–Ω—ã—Ö –∏ –º–æ—Ä—Å–∫–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
//! 2. **–†–æ—Å—Ç –ø—Ä–æ–≤–∏–Ω—Ü–∏–π** ‚Äî —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç —Å–µ–º—è–Ω —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
//!
//! ## –ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
//!
//! ### –≠—Ç–∞–ø 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–º—è–Ω (`generate_province_seeds`)
//! - **–°—É—à–∞**: –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —Ç–æ—á–∫–∏ —Å –≤—ã—Å–æ–∫–æ–π "–ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å—é" –Ω–∞ –æ—Å–Ω–æ–≤–µ:
//!   - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (—É–º–µ—Ä–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ)
//!   - –í–ª–∞–∂–Ω–æ—Å—Ç–∏ (–ª–µ—Å–∞ –∏ —Ä–∞–≤–Ω–∏–Ω—ã > –ø—É—Å—Ç—ã–Ω–∏ –∏ –≥–æ—Ä—ã)
//!   - –í—ã—Å–æ—Ç—ã (–∏–∑–±–µ–≥–∞–µ–º —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –≤—ã—Å–æ—Ç)
//! - **–ú–æ—Ä–µ**: —Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ–∫–µ–∞–Ω–∏—á–µ—Å–∫–∏–º —Ä–µ–≥–∏–æ–Ω–∞–º
//!
//! ### –≠—Ç–∞–ø 2: –†–æ—Å—Ç –ø—Ä–æ–≤–∏–Ω—Ü–∏–π (`generate_provinces_from_seeds`)
//! 1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** ‚Äî —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å–µ–º—è–Ω –Ω–∞ –∫–∞—Ä—Ç–µ
//! 2. **Flood Fill** ‚Äî —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç —Å–µ–º—è–Ω —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ —Ç–∏–ø—É –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏:
//!    - –°—É—à–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—É—à—É
//!    - –ú–æ—Ä–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ—Ä–µ
//! 3. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –≤–æ –≤—Ä–µ–º—è —Ä–æ—Å—Ç–∞:
//!    - –ü–æ–¥—Å—á—ë—Ç –ø–ª–æ—â–∞–¥–∏
//!    - –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å
//!    - –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –±–∏–æ–º–∞–º
//!    - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–±—Ä–µ–∂–Ω–æ—Å—Ç–∏
//! 4. **–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è** ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:
//!    - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å: `(Œ£x / –ø–ª–æ—â–∞–¥—å, Œ£y / –ø–ª–æ—â–∞–¥—å)`
//!    - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–æ–º–æ–≤: `–¥–æ–ª—è = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–ø–∏–∫—Å–µ–ª–µ–π / –ø–ª–æ—â–∞–¥—å`
//!    - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ (–∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç/–æ—Å—Ç—Ä–æ–≤/–æ–∫–µ–∞–Ω)
//! 5. **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ "–¥—ã—Ä"** ‚Äî –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–∏–∫—Å–µ–ª–µ–π –±–ª–∏–∂–∞–π—à–µ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
//!
//! ## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
//! - **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**: –≤—Å–µ —ç—Ç–∞–ø—ã –∑–∞–≤–∏—Å—è—Ç —Ç–æ–ª—å–∫–æ –æ—Ç —Å–∏–¥–∞ –∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
//! - **–¢–∏–ø –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏**: —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—É—à–∞/–º–æ—Ä–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
//! - **–ü—Ä–∏–±—Ä–µ–∂–Ω–æ—Å—Ç—å**: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å –≤–æ–¥–æ–π
//! - **–¶–≤–µ—Ç–∞**: –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ `id` –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

use crate::biome::BiomeMap;
use crate::heightmap::Heightmap;
use crate::province::water::WaterType;
use crate::province::{Province, ProvinceType};
use rand::{Rng, SeedableRng};
use std::collections::HashMap;
use std::collections::hash_map::DefaultHasher;
use std::hash::{Hash, Hasher};

/// 4 –æ—Å–Ω–æ–≤–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–∏–Ω—Ü–∏–π (–±–µ–∑ –¥–∏–∞–≥–æ–Ω–∞–ª–µ–π)
///
/// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–ª–≥–æ—Ä–∏—Ç–º–µ Flood Fill –¥–ª—è:
/// - –°–æ–∑–¥–∞–Ω–∏—è –±–æ–ª–µ–µ "–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö" –≥—Ä–∞–Ω–∏—Ü (–±–µ–∑ –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤)
/// - –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–≤—è–∑–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–∏–Ω—Ü–∏–π (4-—Å–≤—è–∑–Ω–æ—Å—Ç—å –≤–º–µ—Å—Ç–æ 8-—Å–≤—è–∑–Ω–æ—Å—Ç–∏)
/// - –£–ø—Ä–æ—â–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–±—Ä–µ–∂–Ω–æ—Å—Ç–∏
const DIRECTIONS: [(i32, i32); 4] = [(0, 1), (1, 0), (0, -1), (-1, 0)];

/// –°–µ–º—è –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ ‚Äî –Ω–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è —Ä–æ—Å—Ç–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
///
/// –°–µ–º–µ–Ω–∞ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –≤ "–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã—Ö" –ª–æ–∫–∞—Ü–∏—è—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤.
/// –ö–∞–∂–¥–æ–µ —Å–µ–º—è –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –æ–¥–Ω—É –ø—Ä–æ–≤–∏–Ω—Ü–∏—é —á–µ—Ä–µ–∑ –∞–ª–≥–æ—Ä–∏—Ç–º Flood Fill.
#[derive(Debug, Clone)]
pub struct ProvinceSeed {
    /// X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —Å–µ–º–µ–Ω–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö (`0..—à–∏—Ä–∏–Ω–∞_–∫–∞—Ä—Ç—ã`)
    pub x: f32,
    /// Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —Å–µ–º–µ–Ω–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö (`0..–≤—ã—Å–æ—Ç–∞_–∫–∞—Ä—Ç—ã`)
    pub y: f32,
    /// –í–µ—Å "–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ—Å—Ç–∏" –ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å–µ–º–µ–Ω–∏
    ///
    /// –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:
    /// - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (—É–º–µ—Ä–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã –∏–º–µ—é—Ç –±–æ–ª—å—à–∏–π –≤–µ—Å)
    /// - –í–ª–∞–∂–Ω–æ—Å—Ç–∏ (–ø–ª–æ–¥–æ—Ä–æ–¥–Ω—ã–µ –±–∏–æ–º—ã –∏–º–µ—é—Ç –±–æ–ª—å—à–∏–π –≤–µ—Å)
    /// - –í—ã—Å–æ—Ç—ã (–∏–∑–±–µ–≥–∞–µ–º —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –≤—ã—Å–æ—Ç)
    ///
    /// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–µ–º—è–Ω.
    pub weight: f32,
    /// –¢–∏–ø –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ —Å–µ–º–µ–Ω–∏
    ///
    /// –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –±—É–¥–µ—Ç –ª–∏ –ø—Ä–æ–≤–∏–Ω—Ü–∏—è —Å—É—Ö–æ–ø—É—Ç–Ω–æ–π –∏–ª–∏ –º–æ—Ä—Å–∫–æ–π:
    /// - `true` ‚Äî —Å–µ–º—è —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ —Å—É—à–µ ‚Üí –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–∞–ª—å–Ω–∞—è/–æ—Å—Ç—Ä–æ–≤–Ω–∞—è –ø—Ä–æ–≤–∏–Ω—Ü–∏—è
    /// - `false` ‚Äî —Å–µ–º—è —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ –æ–∫–µ–∞–Ω–µ ‚Üí –æ–∫–µ–∞–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–∏–Ω—Ü–∏—è
    pub is_land: bool,
}

/// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ—ë –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
///
/// # –ê–ª–≥–æ—Ä–∏—Ç–º
/// 1. –•–µ—à–∏—Ä—É–µ–º `id` —á–µ—Ä–µ–∑ `DefaultHasher`
/// 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã RGB –∏–∑ —Ö–µ—à–∞:
///    - –ö—Ä–∞—Å–Ω—ã–π: –±–∏—Ç—ã 16-23
///    - –ó–µ–ª—ë–Ω—ã–π: –±–∏—Ç—ã 8-15
///    - –°–∏–Ω–∏–π: –±–∏—Ç—ã 0-7
/// 3. –°–º–µ—â–∞–µ–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 50-205 –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ö–æ—Ä–æ—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
/// 4. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∫ HEX-—Å—Ç—Ä–æ–∫—É `"#rrggbb"`
///
/// # –ì–∞—Ä–∞–Ω—Ç–∏–∏
/// - –û–¥–∏–Ω–∞–∫–æ–≤—ã–π `id` ‚Üí –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ü–≤–µ—Ç (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)
/// - –¶–≤–µ—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è
/// - –ò–∑–±–µ–≥–∞–µ–º —Å–ª–∏—à–∫–æ–º —Ç—ë–º–Ω—ã—Ö (`<50`) –∏ —Å–ª–∏—à–∫–æ–º —Å–≤–µ—Ç–ª—ã—Ö (`>205`) –æ—Ç—Ç–µ–Ω–∫–æ–≤
///
/// # –ü—Ä–∏–º–µ—Ä
/// ```rust
/// let color = hash_to_color(42);
/// assert_eq!(color, "#a1b2c3"); // –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
/// ```
fn hash_to_color(id: u32) -> String {
    let mut hasher = DefaultHasher::new();
    id.hash(&mut hasher);
    let hash = hasher.finish();
    let r = ((hash >> 16) % 156) as u8 + 50; // 50..205
    let g = ((hash >> 8) % 156) as u8 + 50;
    let b = (hash % 156) as u8 + 50;
    format!("#{r:02x}{g:02x}{b:02x}")
}

/// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–∞–±–æ—Ä —Å–µ–º—è–Ω –¥–ª—è –ø—Ä–æ–≤–∏–Ω—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
///
/// # –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ —Å—É—Ö–æ–ø—É—Ç–Ω—ã—Ö —Å–µ–º—è–Ω
/// 1. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ —Å—É—à–∏ –∫–∞–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
/// 2. –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Å –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏:
///    ```text
///    weight = —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π_—Ñ–∞–∫—Ç–æ—Ä √ó –≤–ª–∞–∂–Ω–æ—Å—Ç–Ω—ã–π_—Ñ–∞–∫—Ç–æ—Ä √ó –≤—ã—Å–æ—Ç–Ω—ã–π_—Ñ–∞–∫—Ç–æ—Ä
///    ```
///    - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä: `1.0 - |–≤—ã—Å–æ—Ç–∞ - 0.5|` (—É–º–µ—Ä–µ–Ω–Ω—ã–µ –≤—ã—Å–æ—Ç—ã –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ)
///    - –í–ª–∞–∂–Ω–æ—Å—Ç–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–∏–æ–º–∞:
///      - –ë–æ–ª–æ—Ç–∞/—Ç—Ä–æ–ø–∏–∫–∏: 1.0 (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ–¥–æ—Ä–æ–¥–Ω–æ—Å—Ç—å)
///      - –†–∞–≤–Ω–∏–Ω—ã/–ª–µ—Å–∞: 0.7 (—Ö–æ—Ä–æ—à–∞—è –ø–ª–æ–¥–æ—Ä–æ–¥–Ω–æ—Å—Ç—å)
///      - –û—Å—Ç–∞–ª—å–Ω—ã–µ: 0.3 (–Ω–∏–∑–∫–∞—è –ø–ª–æ–¥–æ—Ä–æ–¥–Ω–æ—Å—Ç—å)
///    - –í—ã—Å–æ—Ç–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä: `1.0 - |–≤—ã—Å–æ—Ç–∞ - 0.5|` (–∏–∑–±–µ–≥–∞–µ–º —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤)
/// 3. –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –≤–µ—Å—É –ø–æ —É–±—ã–≤–∞–Ω–∏—é
/// 4. –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º `num_land` —Ç–æ—á–µ–∫ –∏–∑ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
///
/// # –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ –º–æ—Ä—Å–∫–∏—Ö —Å–µ–º—è–Ω
/// 1. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –æ–∫–µ–∞–Ω–∞
/// 2. –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º `num_sea` —Ç–æ—á–µ–∫ (—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
/// 3. –í–µ—Å –º–æ—Ä—Å–∫–∏—Ö —Å–µ–º—è–Ω —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω (`0.5`) ‚Äî –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∞–ª–≥–æ—Ä–∏—Ç–º
///
/// # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
/// * `heightmap` ‚Äî –∫–∞—Ä—Ç–∞ –≤—ã—Å–æ—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–ª—å–µ—Ñ–∞
/// * `biome_map` ‚Äî –∫–∞—Ä—Ç–∞ –±–∏–æ–º–æ–≤ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–ª–æ–¥–æ—Ä–æ–¥–Ω–æ—Å—Ç–∏
/// * `water_type` ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–æ–¥—ã (—Å—É—à–∞/–æ–∫–µ–∞–Ω) –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ —Å–µ–º—è–Ω
/// * `num_land` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É—Ö–æ–ø—É—Ç–Ω—ã—Ö —Å–µ–º—è–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
/// * `num_sea` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ—Ä—Å–∫–∏—Ö —Å–µ–º—è–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
/// * `seed` ‚Äî —Å–∏–¥ –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–æ—Ä—Å–∫–∏—Ö —Å–µ–º—è–Ω
///
/// # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç
/// –í–µ–∫—Ç–æ—Ä `ProvinceSeed` –¥–ª–∏–Ω–æ–π `num_land + num_sea`
///
/// # –ü—Ä–∏–º–µ—Ä
/// ```rust
/// let seeds = generate_province_seeds(
///     &heightmap,
///     &biome_map,
///     &water_type,
///     80,  // 80 —Å—É—Ö–æ–ø—É—Ç–Ω—ã—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
///     40,  // 40 –º–æ—Ä—Å–∫–∏—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
///     42,  // —Å–∏–¥
/// );
/// ```
#[must_use]
pub fn generate_province_seeds(
    heightmap: &Heightmap,
    biome_map: &BiomeMap,
    water_type: &[WaterType],
    num_land: usize,
    num_sea: usize,
    seed: u64,
) -> Vec<ProvinceSeed> {
    let width = heightmap.width as usize;
    let height = heightmap.height as usize;
    let mut rng = rand_chacha::ChaCha8Rng::seed_from_u64(seed);

    let mut candidates = Vec::new();

    // –°–æ–±–∏—Ä–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —Å—É—à–µ —Å –≤–µ—Å–æ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–æ–¥–æ—Ä–æ–¥–Ω–æ—Å—Ç–∏
    for y in 0..height {
        for x in 0..width {
            let idx = y * width + x;
            if water_type[idx] == WaterType::Land {
                let h = heightmap.data[idx];
                let b = biome_map.data[idx];
                let temp = 1.0 - h.abs();
                let humid = match b {
                    crate::biome::Biome::Swamp | crate::biome::Biome::TropicalRainforest => 1.0,
                    crate::biome::Biome::Grassland | crate::biome::Biome::TemperateForest => 0.7,
                    _ => 0.3,
                };
                let weight = temp * humid * (1.0 - h.abs());
                candidates.push(ProvinceSeed {
                    x: x as f32,
                    y: y as f32,
                    weight,
                    is_land: true,
                });
            }
        }
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Å—É (–Ω–∞–∏–±–æ–ª–µ–µ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏ –ø–µ—Ä–≤—ã–º–∏)
    candidates.sort_by(|a, b| {
        b.weight
            .partial_cmp(&a.weight)
            .unwrap_or(std::cmp::Ordering::Equal)
    });

    let mut selected = Vec::with_capacity(num_land + num_sea);

    // –í—ã–±–∏—Ä–∞–µ–º —Å—É—Ö–æ–ø—É—Ç–Ω—ã–µ —Å–µ–º–µ–Ω–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –∏–∑ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    if !candidates.is_empty() && num_land > 0 {
        let step = (candidates.len() - 1) / num_land.max(1);
        for i in 0..num_land {
            let idx = (i * step).min(candidates.len() - 1);
            selected.push(candidates[idx].clone());
        }
    }

    // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –æ–∫–µ–∞–Ω–∞ –¥–ª—è –º–æ—Ä—Å–∫–∏—Ö —Å–µ–º—è–Ω
    let mut sea_points = Vec::new();
    for y in 0..height {
        for x in 0..width {
            if water_type[y * width + x] == WaterType::Ocean {
                sea_points.push((x as f32, y as f32));
            }
        }
    }

    // –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –º–æ—Ä—Å–∫–∏–µ —Å–µ–º–µ–Ω–∞
    for _ in 0..num_sea {
        if sea_points.is_empty() {
            break;
        }
        let i = rng.gen_range(0..sea_points.len());
        let (x, y) = sea_points.remove(i);
        selected.push(ProvinceSeed {
            x,
            y,
            weight: 0.5,
            is_land: false,
        });
    }

    selected
}

/// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –º–∏—Ä–∞ –∏–∑ –Ω–∞–±–æ—Ä–∞ —Å–µ–º—è–Ω —á–µ—Ä–µ–∑ –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–æ—Å—Ç–∞
///
/// # –ü–æ—à–∞–≥–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
///
/// ## –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
/// - –ö–∞–∂–¥–æ–µ —Å–µ–º—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ü–µ–Ω—Ç—Ä–æ–º –Ω–æ–≤–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
/// - –°–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞—Ä—Ç–∞ `province_id_map` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –ø–∏–∫—Å–µ–ª–µ–π
/// - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å –¥–ª—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ Flood Fill
///
/// ## –®–∞–≥ 2: Flood Fill —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö
/// –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏:
/// 1. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–ª–æ—â–∞–¥–∏**: `–ø—Ä–æ–≤–∏–Ω—Ü–∏—è.–ø–ª–æ—â–∞–¥—å += 1`
/// 2. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å**:
///    ```text
///    –ø—Ä–æ–≤–∏–Ω—Ü–∏—è.—Ü–µ–Ω—Ç—Ä.x += x
///    –ø—Ä–æ–≤–∏–Ω—Ü–∏—è.—Ü–µ–Ω—Ç—Ä.y += y
///    ```
/// 3. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –±–∏–æ–º–æ–≤**:
///    ```text
///    –ø—Ä–æ–≤–∏–Ω—Ü–∏—è.–±–∏–æ–º—ã[—Ç–µ–∫—É—â–∏–π_–±–∏–æ–º] += 1.0
///    ```
/// 4. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–±—Ä–µ–∂–Ω–æ—Å—Ç–∏** (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—à–∏):
///    - –ü—Ä–æ–≤–µ—Ä—è–µ–º 4 —Å–æ—Å–µ–¥–∞
///    - –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–æ—Å–µ–¥ ‚Äî –≤–æ–¥–∞ ‚Üí `–ø—Ä–æ–≤–∏–Ω—Ü–∏—è.coastal = true`
/// 5. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å–µ–¥–µ–π –≤ –æ—á–µ—Ä–µ–¥—å**:
///    - –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–æ—Å–µ–¥–µ–π —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (—Å—É—à–∞‚Üí—Å—É—à–∞, –º–æ—Ä–µ‚Üí–º–æ—Ä–µ)
///    - –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —É–∂–µ –∑–∞–Ω—è—Ç—ã–µ –ø–∏–∫—Å–µ–ª–∏
///
/// ## –®–∞–≥ 3: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
/// –î–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏:
/// 1. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å**:
///    ```text
///    —Ü–µ–Ω—Ç—Ä.x = Œ£x / –ø–ª–æ—â–∞–¥—å
///    —Ü–µ–Ω—Ç—Ä.y = Œ£y / –ø–ª–æ—â–∞–¥—å
///    ```
/// 2. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–æ–º–æ–≤**:
///    ```text
///    –¥–æ–ª—è[–±–∏–æ–º] = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–ø–∏–∫—Å–µ–ª–µ–π[–±–∏–æ–º] / –ø–ª–æ—â–∞–¥—å
///    ```
/// 3. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏**:
///    - –ú–æ—Ä–µ ‚Üí `Oceanic`
///    - –°—É—à–∞ + –ø—Ä–∏–±—Ä–µ–∂–Ω–∞—è + –ø–ª–æ—â–∞–¥—å < 500 ‚Üí `Island`
///    - –°—É—à–∞ + –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏ ‚Üí `Continental`
///
/// ## –®–∞–≥ 4: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–∏–∫—Å–µ–ª–µ–π
/// - –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–∏–∫—Å–µ–ª–∏ –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã–º–∏ –∏–∑-–∑–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π
/// - –ö–∞–∂–¥—ã–π –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã–π –ø–∏–∫—Å–µ–ª—å –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –±–ª–∏–∂–∞–π—à–µ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–æ —Ü–µ–Ω—Ç—Ä–∞
/// - –ü–ª–æ—â–∞–¥—å –∏ –±–∏–æ–º—ã –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
///
/// # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
/// * `heightmap` ‚Äî –∫–∞—Ä—Ç–∞ –≤—ã—Å–æ—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–ª—å–µ—Ñ–∞
/// * `biome_map` ‚Äî –∫–∞—Ä—Ç–∞ –±–∏–æ–º–æ–≤ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
/// * `water_type` ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–æ–¥—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
/// * `seeds` ‚Äî –Ω–∞–±–æ—Ä —Å–µ–º—è–Ω, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ—Ä–µ–∑ `generate_province_seeds`
///
/// # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç
/// –ö–æ—Ä—Ç–µ–∂ `(–ø—Ä–æ–≤–∏–Ω—Ü–∏–∏, –∫–∞—Ä—Ç–∞_–ø–∏–∫—Å–µ–ª–µ–π)`:
/// * `–ø—Ä–æ–≤–∏–Ω—Ü–∏–∏` ‚Äî –≤–µ–∫—Ç–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä `Province` —Å–æ –≤—Å–µ–π –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
/// * `–∫–∞—Ä—Ç–∞_–ø–∏–∫—Å–µ–ª–µ–π` ‚Äî –≤–µ–∫—Ç–æ—Ä `u32` –¥–ª–∏–Ω–æ–π `—à–∏—Ä–∏–Ω–∞ √ó –≤—ã—Å–æ—Ç–∞`, –≥–¥–µ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî `province_id`
///
/// # –ì–∞—Ä–∞–Ω—Ç–∏–∏
/// - –ö–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å –∫–∞—Ä—Ç—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ä–æ–≤–Ω–æ –æ–¥–Ω–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
/// - –í—Å–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å–≤—è–∑–Ω—ã (4-—Å–≤—è–∑–Ω–æ—Å—Ç—å)
/// - –°—É—à–∞ –∏ –º–æ—Ä–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
/// - –ê–ª–≥–æ—Ä–∏—Ç–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
///
/// # –ü—Ä–∏–º–µ—Ä
/// ```rust
/// let (provinces, pixel_to_id) = generate_provinces_from_seeds(
///     &heightmap,
///     &biome_map,
///     &water_type,
///     &seeds,
/// );
/// ```
#[allow(clippy::too_many_lines)]
#[allow(clippy::missing_panics_doc)]
#[must_use]
pub fn generate_provinces_from_seeds(
    heightmap: &Heightmap,
    biome_map: &BiomeMap,
    water_type: &[WaterType],
    seeds: &[ProvinceSeed],
) -> (Vec<Province>, Vec<u32>) {
    let width = heightmap.width as usize;
    let height = heightmap.height as usize;
    let total = width * height;

    let mut province_id_map: Vec<Option<u32>> = vec![None; total];
    let mut provinces: Vec<Province> = Vec::with_capacity(seeds.len());
    let mut queue = std::collections::VecDeque::new();

    // –®–ê–ì 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å–µ–º—è–Ω
    for (pid, seed) in seeds.iter().enumerate() {
        let x = seed.x as usize;
        let y = seed.y as usize;
        let idx = y * width + x;

        if idx < total {
            province_id_map[idx] = Some(pid as u32);
            provinces.push(Province {
                id: pid as u32,
                name: format!("Prov_{pid}"),
                province_type: if seed.is_land {
                    ProvinceType::Continental
                } else {
                    ProvinceType::Oceanic
                },
                is_land: seed.is_land,
                coastal: false,
                center: (0.0, 0.0),
                area: 0,
                biomes: HashMap::new(),
                color: hash_to_color(pid as u32),
            });
            queue.push_back((x, y, pid as u32));
        }
    }

    // –®–ê–ì 2: Flood Fill —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö
    while let Some((x, y, pid)) = queue.pop_front() {
        let province = &mut provinces[pid as usize];
        let idx = y * width + x;

        // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        province.area += 1;
        let biome_name = format!("{:?}", biome_map.data[idx]);
        *province.biomes.entry(biome_name).or_insert(0.0) += 1.0;
        province.center.0 += x as f32;
        province.center.1 += y as f32;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–±—Ä–µ–∂–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—à–∏)
        if province.is_land {
            for &(dx, dy) in &DIRECTIONS {
                let nx = (x as i32 + dx).rem_euclid(width as i32) as usize;
                let ny = (y as i32 + dy).clamp(0, (height - 1) as i32) as usize;
                let nidx = ny * width + nx;
                if water_type[nidx] != WaterType::Land {
                    province.coastal = true;
                    break;
                }
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å–µ–¥–µ–π (—Ç–æ–ª—å–∫–æ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏)
        for &(dx, dy) in &DIRECTIONS {
            let nx = (x as i32 + dx).rem_euclid(width as i32) as usize;
            let ny = (y as i32 + dy).clamp(0, (height - 1) as i32) as usize;
            let nidx = ny * width + nx;

            if province_id_map[nidx].is_none() {
                let neighbor_is_land = water_type[nidx] == WaterType::Land;
                if province.is_land == neighbor_is_land {
                    province_id_map[nidx] = Some(pid);
                    queue.push_back((nx, ny, pid));
                }
            }
        }
    }

    // –®–ê–ì 3: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    for province in &mut provinces {
        if province.area > 0 {
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å
            province.center.0 /= province.area as f32;
            province.center.1 /= province.area as f32;

            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–æ–º–æ–≤
            for count in province.biomes.values_mut() {
                *count /= province.area as f32;
            }

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
            province.province_type = if !province.is_land {
                ProvinceType::Oceanic
            } else if province.coastal && province.area < 500 {
                ProvinceType::Island
            } else {
                ProvinceType::Continental
            };
        }
    }

    // –®–ê–ì 4: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–∏–∫—Å–µ–ª–µ–π
    let uncovered = province_id_map.iter().filter(|o| o.is_none()).count();
    if uncovered > 0 {
        println!("üîç –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ {uncovered} –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π...");

        // –°–æ–±–∏—Ä–∞–µ–º —Ü–µ–Ω—Ç—Ä—ã –≤—Å–µ—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π
        let centers: Vec<(f32, f32)> = provinces.iter().map(|p| p.center).collect();

        for y in 0..height {
            for x in 0..width {
                let idx = y * width + x;
                if province_id_map[idx].is_none() {
                    // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏—é –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–æ —Ü–µ–Ω—Ç—Ä–∞
                    let mut min_d2 = f32::MAX;
                    let mut best_pid = 0;
                    for (pid, &(cx, cy)) in centers.iter().enumerate() {
                        let d2 = (x as f32 - cx).powi(2) + (y as f32 - cy).powi(2);
                        if d2 < min_d2 {
                            min_d2 = d2;
                            best_pid = pid as u32;
                        }
                    }

                    // –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–∏–∫—Å–µ–ª—å –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
                    province_id_map[idx] = Some(best_pid);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
                    let province = &mut provinces[best_pid as usize];
                    province.area += 1;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∏–æ–º (–≤–∞–∂–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–∞–≤–∞)
                    let biome_name = format!("{:?}", biome_map.data[idx]);
                    *province.biomes.entry(biome_name).or_insert(0.0) += 1.0;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –º–∞—Å—Å
                    province.center.0 += x as f32;
                    province.center.1 += y as f32;
                }
            }
        }

        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è "–¥—ã—Ä"
        for province in &mut provinces {
            if province.area > 0 {
                province.center.0 /= province.area as f32;
                province.center.1 /= province.area as f32;

                for count in province.biomes.values_mut() {
                    *count /= province.area as f32;
                }
            }
        }
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–∞—Ä—Ç—É –≤ –≤–µ–∫—Ç–æ—Ä u32
    let pixel_to_id: Vec<u32> = province_id_map
        .into_iter()
        .map(|opt| opt.unwrap()) // –í—Å–µ –ø–∏–∫—Å–µ–ª–∏ –ø–æ–∫—Ä—ã—Ç—ã –ø–æ—Å–ª–µ –®–∞–≥–∞ 4
        .collect();

    (provinces, pixel_to_id)
}
