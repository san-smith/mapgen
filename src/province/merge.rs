// src/province/merge.rs
//! –°–ª–∏—è–Ω–∏–µ –º–µ–ª–∫–∏—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
//!
//! –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–æ–≤–∏–Ω—Ü–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≥–µ–π–º–ø–ª–µ—è:
//! —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑–ª–∏—à–Ω–µ –º–µ–ª–∫–∏—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π –ø—É—Ç—ë–º –∏—Ö —Å–ª–∏—è–Ω–∏—è —Å –∫—Ä—É–ø–Ω—ã–º–∏ —Å–æ—Å–µ–¥—è–º–∏.
//!
//! ## –ó–∞—á–µ–º –Ω—É–∂–Ω–æ —Å–ª–∏—è–Ω–∏–µ?
//!
//! –ú–µ–ª–∫–∏–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ (< 50 –ø–∏–∫—Å–µ–ª–µ–π) —Å–æ–∑–¥–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –≥–µ–π–º–ø–ª–µ—è:
//! - –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–∏–∫—Ä–æ-—Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π —É—Å–ª–æ–∂–Ω—è–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
//! - –ê—Ä–º–∏–∏ –Ω–µ –º–æ–≥—É—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –º–∞–Ω–µ–≤—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ "–∏–≥–æ–ª—å–Ω—ã–µ —É—à–∏"
//! - –≠–∫–æ–Ω–æ–º–∏–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏ –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π
//! - –ö–∞—Ä—Ç–∞ –≤—ã–≥–ª—è–¥–∏—Ç "–∑–∞—à—É–º–ª—ë–Ω–Ω–æ–π" —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –º–µ–ª–∫–∏—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
//!
//! ## –ê–ª–≥–æ—Ä–∏—Ç–º —Å–ª–∏—è–Ω–∏—è
//!
//! 1. **–ü–æ–∏—Å–∫ –º–µ–ª–∫–∏—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π**:
//!    - –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏–º –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å –ø–ª–æ—â–∞–¥—å—é < `MIN_AREA_THRESHOLD`
//!    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –º–µ–ª–∫–∏–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
//!
//! 2. **–í—ã–±–æ—Ä —Å–æ—Å–µ–¥–∞ –¥–ª—è —Å–ª–∏—è–Ω–∏—è**:
//!    - –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ—Å–µ–¥–µ–π —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (—Å—É—à–∞‚Üí—Å—É—à–∞, –º–æ—Ä–µ‚Üí–º–æ—Ä–µ)
//!    - –í—ã–±–∏—Ä–∞–µ–º —Å–æ—Å–µ–¥–∞ —Å **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø–ª–æ—â–∞–¥—å—é** –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
//!    - –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞—Ñ —Å–º–µ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å–µ–¥—Å—Ç–≤–∞
//!
//! 3. **–°–ª–∏—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**:
//!    - **–¶–µ–Ω—Ç—Ä –º–∞—Å—Å**: –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –ø–æ –ø–ª–æ—â–∞–¥–∏
//!      ```text
//!      x_new = (x_large * area_large + x_small * area_small) / (area_large + area_small)
//!      ```
//!    - **–ë–∏–æ–º–Ω—ã–π —Å–æ—Å—Ç–∞–≤**: –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–æ–ª–µ–π
//!      ```text
//!      ratio_new[–±–∏–æ–º] = (ratio_large[–±–∏–æ–º] * area_large + ratio_small[–±–∏–æ–º] * area_small) / total_area
//!      ```
//!    - **–ü—Ä–∏–±—Ä–µ–∂–Ω–æ—Å—Ç—å**: –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ò–õ–ò (`coastal_new = coastal_large || coastal_small`)
//!    - **–ü–ª–æ—â–∞–¥—å**: —Å—É–º–º–∞ –ø–ª–æ—â–∞–¥–µ–π (`area_new = area_large + area_small`)
//!
//! 4. **–£–¥–∞–ª–µ–Ω–∏–µ –º–µ–ª–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏**:
//!    - –ü—Ä–æ–≤–∏–Ω—Ü–∏—è —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
//!    - –ì—Ä–∞—Ñ —Å–º–µ–∂–Ω–æ—Å—Ç–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π)
//!
//! ## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
//!
//! - **–¢–∏–ø –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**: —Å—É—à–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–ª–∏–≤–∞–µ—Ç—Å—è —Å –º–æ—Ä–µ–º
//! - **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥**: –ø–æ—Å–ª–µ —Å–ª–∏—è–Ω–∏—è –º–æ–≥—É—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ –º–µ–ª–∫–∏–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
//! - **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**: –≤—ã–±–æ—Ä —Å–æ—Å–µ–¥–∞ –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø–ª–æ—â–∞–¥–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å
//! - **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏—è**: –¥–∞–Ω–Ω—ã–µ –º–µ–ª–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –≤–µ–∫—Ç–æ—Ä–∞
//! - **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: —Å–ª–æ–∂–Ω–æ—Å—Ç—å O(N √ó M), –≥–¥–µ N ‚Äî —á–∏—Å–ª–æ –ø—Ä–æ–≤–∏–Ω—Ü–∏–π, M ‚Äî —á–∏—Å–ª–æ —Å–æ—Å–µ–¥–µ–π

use crate::province::Province;
use petgraph::graph::UnGraph;
use std::collections::HashMap;

/// –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–æ–ø—É—Å—Ç–∏–º–∞—è –ø–ª–æ—â–∞–¥—å –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
///
/// –ü—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å –ø–ª–æ—â–∞–¥—å—é –º–µ–Ω—å—à–µ —ç—Ç–æ–≥–æ –ø–æ—Ä–æ–≥–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è "—Å–ª–∏—à–∫–æ–º –º–µ–ª–∫–∏–º–∏" –¥–ª—è –≥–µ–π–º–ø–ª–µ—è
/// –∏ –ø–æ–¥–ª–µ–∂–∞—Ç —Å–ª–∏—è–Ω–∏—é —Å –∫—Ä—É–ø–Ω—ã–º–∏ —Å–æ—Å–µ–¥—è–º–∏.
///
/// # –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏—è
/// - `50` –ø–∏–∫—Å–µ–ª–µ–π ‚âà 7√ó7 –∫–≤–∞–¥—Ä–∞—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
/// - –ú–µ–Ω—å—à–µ —ç—Ç–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ–≤–∏–Ω—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –≤–º–µ—Å—Ç–∏—Ç—å –∑–Ω–∞—á–∏–º—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
/// - –û–ø—ã—Ç –∏–≥—Ä-—Å—Ç—Ä–∞—Ç–µ–≥–∏–π (Crusader Kings, Europa Universalis) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—Å—Ç—å —ç—Ç–æ–≥–æ –ø–æ—Ä–æ–≥–∞
/// - –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –∫–∞—Ä—Ç—ã –∏ —É–¥–æ–±—Å—Ç–≤–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
const MIN_AREA_THRESHOLD: usize = 50;
const MAX_ITERATIONS: usize = 1000; // –∑–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

/// –°–ª–∏–≤–∞–µ—Ç –≤—Å–µ –º–µ–ª–∫–∏–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å –∏—Ö –∫—Ä—É–ø–Ω–µ–π—à–∏–º–∏ —Å–æ—Å–µ–¥—è–º–∏
///
/// # –ê–ª–≥–æ—Ä–∏—Ç–º
/// 1. –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ –∏—â–µ—Ç –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å –ø–ª–æ—â–∞–¥—å—é < `MIN_AREA_THRESHOLD`
/// 2. –î–ª—è –∫–∞–∂–¥–æ–π –º–µ–ª–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `merge_one_small_province`
/// 3. –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –º–µ–ª–∫–∏–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
///    (—Å–ª–∏—è–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –º–µ–ª–∫–∏–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–ª–æ—â–∞–¥–µ–π —Å–æ—Å–µ–¥–µ–π)
///
/// # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
/// * `provinces` ‚Äî mutable-—Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ–∫—Ç–æ—Ä –ø—Ä–æ–≤–∏–Ω—Ü–∏–π –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
/// * `graph` ‚Äî –≥—Ä–∞—Ñ —Å–º–µ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å–µ–¥–µ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
///
/// # –≠—Ñ—Ñ–µ–∫—Ç
/// - –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç `provinces` –Ω–∞ –º–µ—Å—Ç–µ:
///   - –£–¥–∞–ª—è–µ—Ç –º–µ–ª–∫–∏–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
///   - –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫—Ä—É–ø–Ω—ã—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π (–ø–ª–æ—â–∞–¥—å, —Ü–µ–Ω—Ç—Ä, –±–∏–æ–º—ã)
/// - –í—ã–≤–æ–¥–∏—Ç –≤ –∫–æ–Ω—Å–æ–ª—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∏—Ç—ã—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
///
/// # –ü—Ä–∏–º–µ—Ä
/// ```rust
/// let mut provinces = vec![/* ... */];
/// let graph = build_province_graph_with_map(&provinces, &pixel_to_id, width, height);
///
/// merge_small_provinces(&mut provinces, &graph);
/// // –¢–µ–ø–µ—Ä—å –≤—Å–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –∏–º–µ—é—Ç –ø–ª–æ—â–∞–¥—å >= MIN_AREA_THRESHOLD
/// ```
pub fn merge_small_provinces(provinces: &mut Vec<Province>, graph: &UnGraph<u32, ()>) {
    let mut merged_count = 0;
    let mut iterations = 0;

    loop {
        iterations += 1;
        if iterations > MAX_ITERATIONS {
            eprintln!("‚ö†Ô∏è  –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∏—Ç–µ—Ä–∞—Ü–∏–π —Å–ª–∏—è–Ω–∏—è ({MAX_ITERATIONS})");
            break;
        }

        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –º–µ–ª–∫—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏—é
        let small_province_id = provinces
            .iter()
            .find(|p| p.area < MIN_AREA_THRESHOLD)
            .map(|p| p.id);

        if let Some(small_id) = small_province_id {
            if merge_one_small_province(provinces, graph, small_id) {
                merged_count += 1;
            } else {
                // –ù–µ —É–¥–∞–ª–æ—Å—å —Å–ª–∏—Ç—å ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
                break;
            }
        } else {
            // –ë–æ–ª—å—à–µ –Ω–µ—Ç –º–µ–ª–∫–∏—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
            break;
        }
    }

    if merged_count > 0 {
        println!(
            "üßπ –°–ª–∏—Ç–æ {merged_count} –º–µ–ª–∫–∏—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π (–ø–ª–æ—â–∞–¥—å < {MIN_AREA_THRESHOLD} –ø–∏–∫—Å–µ–ª–µ–π)."
        );
    } else {
        println!("‚úÖ –í—Å–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –∏–º–µ—é—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä (‚â• {MIN_AREA_THRESHOLD} –ø–∏–∫—Å–µ–ª–µ–π).");
    }
}

/// –°–ª–∏–≤–∞–µ—Ç –æ–¥–Ω—É –º–µ–ª–∫—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏—é —Å –µ—ë –∫—Ä—É–ø–Ω–µ–π—à–∏–º —Å–æ—Å–µ–¥–æ–º —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
///
/// # –ê–ª–≥–æ—Ä–∏—Ç–º
/// 1. –ù–∞—Ö–æ–¥–∏—Ç –º–µ–ª–∫—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏—é –ø–æ `small_id` –≤ —Å–ø–∏—Å–∫–µ `provinces`
/// 2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ—ë —Ç–∏–ø –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (`is_land`)
/// 3. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ—Ö —Å–æ—Å–µ–¥–µ–π —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ —Å–º–µ–∂–Ω–æ—Å—Ç–∏
/// 4. –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ—Å–µ–¥–µ–π –ø–æ —Ç–∏–ø—É –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ —Ç–µ –∂–µ: —Å—É—à–∞‚Üí—Å—É—à–∞, –º–æ—Ä–µ‚Üí–º–æ—Ä–µ)
/// 5. –í—ã–±–∏—Ä–∞–µ—Ç —Å–æ—Å–µ–¥–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø–ª–æ—â–∞–¥—å—é
/// 6. –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–ª–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏—è)
/// 7. –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–∏—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫—Ä—É–ø–Ω–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏:
///    - –¶–µ–Ω—Ç—Ä –º–∞—Å—Å: –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –ø–æ –ø–ª–æ—â–∞–¥–∏
///    - –ë–∏–æ–º—ã: –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–æ–ª–µ–π
///    - –ü—Ä–∏–±—Ä–µ–∂–Ω–æ—Å—Ç—å: –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ò–õ–ò
///    - –ü–ª–æ—â–∞–¥—å: —Å—É–º–º–∞ –ø–ª–æ—â–∞–¥–µ–π
/// 8. –£–¥–∞–ª—è–µ—Ç –º–µ–ª–∫—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞
///
/// # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
/// * `provinces` ‚Äî mutable-—Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ–∫—Ç–æ—Ä –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
/// * `graph` ‚Äî –≥—Ä–∞—Ñ —Å–º–µ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π
/// * `small_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–µ–ª–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –¥–ª—è —Å–ª–∏—è–Ω–∏—è
///
/// # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç
/// * `true` ‚Äî —Å–ª–∏—è–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
/// * `false` ‚Äî —Å–ª–∏—è–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ (–Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–æ—Å–µ–¥–µ–π –∏–ª–∏ –ø—Ä–æ–≤–∏–Ω—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞)
///
/// # –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
/// - **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏**: —Å—É—à–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–ª–∏–≤–∞–µ—Ç—Å—è —Å –º–æ—Ä–µ–º
/// - **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ**: –¥–∞–Ω–Ω—ã–µ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –≤–µ–∫—Ç–æ—Ä–∞ (—Ä–µ—à–∞–µ—Ç –æ—à–∏–±–∫—É E0502)
/// - **–í–∑–≤–µ—à–µ–Ω–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ**: –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–ª–æ—â–∞–¥–∏
///
/// # –ü—Ä–∏–º–µ—Ä
/// ```rust
/// // –ü—Ä–æ–≤–∏–Ω—Ü–∏—è 42 –∏–º–µ–µ—Ç –ø–ª–æ—â–∞–¥—å 30 (< 50) –∏ —Å–æ—Å–µ–¥–µ–π 15 (–ø–ª–æ—â–∞–¥—å 200) –∏ 27 (–ø–ª–æ—â–∞–¥—å 150)
/// let success = merge_one_small_province(&mut provinces, &graph, 42);
/// assert!(success);
/// // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–∏–Ω—Ü–∏—è 42 —É–¥–∞–ª–µ–Ω–∞, –ø—Ä–æ–≤–∏–Ω—Ü–∏—è 15 –∏–º–µ–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω–Ω—É—é –ø–ª–æ—â–∞–¥—å –∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
/// ```
fn merge_one_small_province(
    provinces: &mut Vec<Province>,
    graph: &UnGraph<u32, ()>,
    small_id: u32,
) -> bool {
    // –ù–∞—Ö–æ–¥–∏–º –º–µ–ª–∫—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏—é –∏ –µ—ë –∏–Ω–¥–µ–∫—Å
    let Some(small_idx) = provinces.iter().position(|p| p.id == small_id) else {
        return false; // –ø—Ä–æ–≤–∏–Ω—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
    };

    // –ö–æ–ø–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ–ª–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –î–û –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–º–µ–Ω—è–µ–º–æ–π —Å—Å—ã–ª–∫–∏
    // –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –æ—à–∏–±–∫—É –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏—è E0502
    let small_area = provinces[small_idx].area as f32;
    let small_center = provinces[small_idx].center;
    let small_biomes = provinces[small_idx].biomes.clone(); // HashMap –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è
    let small_coastal = provinces[small_idx].coastal;
    let is_land = provinces[small_idx].is_land;

    // –°—Ç—Ä–æ–∏–º –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    let prov_map: HashMap<u32, usize> = provinces
        .iter()
        .enumerate()
        .map(|(i, p)| (p.id, i))
        .collect();
    let node_map: HashMap<u32, petgraph::graph::NodeIndex> =
        graph.node_indices().map(|idx| (graph[idx], idx)).collect();

    // –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª –º–µ–ª–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ –≤ –≥—Ä–∞—Ñ–µ
    let Some(&small_node_idx) = node_map.get(&small_id) else {
        return false; // —É–∑–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≥—Ä–∞—Ñ–µ
    };

    // –ù–∞—Ö–æ–¥–∏–º –∫—Ä—É–ø–Ω–µ–π—à–µ–≥–æ —Å–æ—Å–µ–¥–∞ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
    let largest_neighbor_id = graph
        .neighbors(small_node_idx)
        .filter_map(|n_idx| {
            let n_id = graph[n_idx];
            prov_map.get(&n_id).map(|&idx| &provinces[idx])
        })
        .filter(|&n_prov| n_prov.is_land == is_land) // —Ç–æ–ª—å–∫–æ —Ç–æ—Ç –∂–µ —Ç–∏–ø –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
        .max_by_key(|&n_prov| n_prov.area)
        .map(|p| p.id);

    if let Some(large_id) = largest_neighbor_id {
        let large_idx = prov_map[&large_id];

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–ø–Ω—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏—é (—Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ ‚Äî –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏—è)
        let large_prov = &mut provinces[large_idx];
        let large_area = large_prov.area as f32;
        let total_area = small_area + large_area;

        // –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å
        large_prov.center.0 =
            (large_prov.center.0 * large_area + small_center.0 * small_area) / total_area;
        large_prov.center.1 =
            (large_prov.center.1 * large_area + small_center.1 * small_area) / total_area;

        // –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–∏–æ–º–æ–≤: –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –í–°–ï –±–∏–æ–º—ã
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –±–∏–æ–º—ã –∏–∑ –æ–±–µ–∏—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏–π
        let mut all_biomes: std::collections::HashMap<String, f32> = HashMap::new();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –±–∏–æ–º—ã –∫—Ä—É–ø–Ω–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å —É—á—ë—Ç–æ–º –≤–µ—Å–∞ –ø–ª–æ—â–∞–¥–∏
        for (biome, ratio) in &large_prov.biomes {
            all_biomes.insert(biome.clone(), ratio * large_area);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –±–∏–æ–º—ã –º–µ–ª–∫–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —Å —É—á—ë—Ç–æ–º –≤–µ—Å–∞ –ø–ª–æ—â–∞–¥–∏
        for (biome, ratio) in &small_biomes {
            let entry = all_biomes.entry(biome.clone()).or_insert(0.0);
            *entry += ratio * small_area;
        }
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Å–µ –±–∏–æ–º—ã –Ω–∞ –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å
        for ratio in all_biomes.values_mut() {
            *ratio /= total_area;
        }
        
        // –ó–∞–º–µ–Ω—è–µ–º HashMap –±–∏–æ–º–æ–≤ –≤ –∫—Ä—É–ø–Ω–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
        large_prov.biomes = all_biomes;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–±—Ä–µ–∂–Ω–æ—Å—Ç–∏ (–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ò–õ–ò)
        large_prov.coastal = large_prov.coastal || small_coastal;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–æ—â–∞–¥–∏
        large_prov.area = total_area as usize;

        // –£–¥–∞–ª—è–µ–º –º–µ–ª–∫—É—é –ø—Ä–æ–≤–∏–Ω—Ü–∏—é –ø–æ –∏–Ω–¥–µ–∫—Å—É
        // –í–∞–∂–Ω–æ: —É–¥–∞–ª—è–µ–º –ü–û–°–õ–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—Ä—É–ø–Ω–æ–π –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏
        // –ò–Ω–¥–µ–∫—Å –æ—Å—Ç–∞—ë—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –∏–∑–º–µ–Ω—è–ª–∏ –≤–µ–∫—Ç–æ—Ä –¥–æ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞
        provinces.remove(small_idx);

        true
    } else {
        // –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–æ—Å–µ–¥–µ–π –¥–ª—è —Å–ª–∏—è–Ω–∏—è
        false
    }
}
