// src/province/mod.rs
//! Система административного деления мира
//!
//! Этот модуль реализует концепцию провинций — базовых административных единиц мира,
//! используемых для геймплея, дипломатии и экономики.
//!
//! ## Архитектура
//! Провинции генерируются в несколько этапов:
//! 1. **Семена (`generator`)** — размещение начальных точек для сухопутных и морских регионов
//! 2. **Рост (`generator`)** — flood-fill от семян с агрегацией данных (площадь, центр, биомы)
//! 3. **Слияние (`merge`)** — объединение мелких провинций для улучшения геймплея
//! 4. **Граф смежности (`graph`)** — построение графа для анализа соседства и маршрутов
//! 5. **Визуализация (`png`)** — рендеринг карты провинций в изображение
//! 6. **Классификация воды (`water`)** — определение типа водной поверхности
//!
//! ## Особенности провинций
//! - Каждая провинция имеет **уникальный цвет** для визуальной идентификации
//! - **Биомный состав** хранится как доли (0.0–1.0) для поддержки смешанных ландшафтов
//! - **Прибрежность** определяется автоматически при генерации
//! - **Тип провинции** влияет на геймплейные механики (торговля, мобилизация)

pub mod generator;
pub mod graph;
pub mod merge;
pub mod png;
pub mod water;

use std::collections::HashMap;

use serde::{Deserialize, Serialize};

/// Тип провинции — определяет её географическое положение и геймплейные свойства
///
/// Тип влияет на:
/// - Доступные здания и улучшения
/// - Стоимость перемещения армий
/// - Торговые возможности
/// - Механики колонизации
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "lowercase")]
pub enum ProvinceType {
    /// Континентальная провинция — крупная сухопутная территория
    ///
    /// Характеристики:
    /// - Может иметь внутренние границы с другими континентальными провинциями
    /// - Обычно имеет развитую инфраструктуру
    /// - Может содержать столицы и крупные города
    /// - Поддерживает все типы зданий
    Continental,

    /// Островная провинция — изолированная сухопутная территория, окружённая водой
    ///
    /// Характеристики:
    /// - Всегда прибрежная (`coastal = true`)
    /// - Ограниченный размер (обычно < 500 пикселей)
    /// - Специальные механики морской торговли
    /// - Может иметь порты даже при малой площади
    Island,

    /// Океаническая провинция — водная территория без суши
    ///
    /// Характеристики:
    /// - `is_land = false`
    /// - Используется для морских маршрутов и флота
    /// - Не поддерживает здания на суше
    /// - Может содержать морские ресурсы (рыболовство, нефть)
    Oceanic,
}

/// Провинция — базовая административная единица мира
///
/// Провинция представляет собой связную территорию с общими характеристиками:
/// - Географическими (биомы, прибрежность)
/// - Административными (название, цвет, тип)
/// - Статистическими (площадь, центр масс)
///
/// Все данные провинции вычисляются детерминированно на этапе генерации.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Province {
    /// Уникальный идентификатор провинции
    ///
    /// Идентификаторы назначаются последовательно при генерации и сохраняются
    /// между запусками с одинаковым сидом для обеспечения детерминированности.
    pub id: u32,

    /// Название провинции
    ///
    /// Генерируется автоматически на основе:
    /// - Доминирующего биома
    /// - Влияния культуры (если реализовано)
    /// - Географического положения (остров/континент)
    ///
    /// Формат: `"Prov_{id}"` по умолчанию, заменяется на осмысленное имя при генерации.
    pub name: String,

    /// Тип провинции (континент/остров/океан)
    ///
    /// Определяется автоматически на основе:
    /// - `is_land` — является ли провинция сушей
    /// - `coastal` — имеет ли провинция выход к морю
    /// - `area` — площадь провинции в пикселях
    ///
    /// См. документацию [`ProvinceType`] для деталей.
    #[serde(rename = "type")]
    pub province_type: ProvinceType,

    /// Цвет провинции в формате HEX
    ///
    /// Формат: `"#rrggbb"` (например, `"#aabbcc"`)
    /// Цвет генерируется детерминированно на основе `id` для обеспечения:
    /// - Уникальности между провинциями
    /// - Стабильности между запусками с одинаковым сидом
    /// - Хорошего контраста для визуального различения
    pub color: String, // "#rrggbb"

    /// Является ли провинция сушей
    ///
    /// Определяется при генерации на основе карты высот:
    /// - `true` — высота ≥ уровня моря (`sea_level`)
    /// - `false` — высота < уровня моря
    ///
    /// Используется для:
    /// - Разделения сухопутных и морских провинций при генерации
    /// - Определения типа провинции (`Oceanic` vs `Continental`/`Island`)
    /// - Геймплейных механик (армия vs флот)
    pub is_land: bool,

    /// Имеет ли провинция выход к морю
    ///
    /// Определяется автоматически при генерации:
    /// - Для сухопутных провинций: `true`, если хотя бы один пиксель граничит с водой
    /// - Для морских провинций: всегда `false` (не применимо)
    ///
    /// Влияет на:
    /// - Возможность строительства портов
    /// - Механики морской торговли
    /// - Стратегическую ценность провинции
    pub coastal: bool,

    /// Центр масс провинции в пиксельных координатах
    ///
    /// Координаты вычисляются как средневзвешенное положение всех пикселей провинции:
    /// ```text
    /// center_x = Σ(x_i) / area
    /// center_y = Σ(y_i) / area
    /// ```
    ///
    /// Используется для:
    /// - Размещения городов и столиц
    /// - Определения расстояний между провинциями
    /// - Визуализации названий на карте
    pub center: (f32, f32),

    /// Площадь провинции в пикселях
    ///
    /// Определяется как количество пикселей, принадлежащих провинции.
    /// Используется для:
    /// - Балансировки ресурсов (большие провинции = больше ресурсов)
    /// - Определения типа провинции (островная при малой площади)
    /// - Геймплейных механик (налоги, рекрутинг)
    pub area: usize,

    /// Биомный состав провинции
    ///
    /// Хранится как карта `биом → доля`, где:
    /// - Ключ — название биома в формате `String` (например, `"TemperateForest"`)
    /// - Значение — доля биома в провинции (0.0–1.0, сумма ≈ 1.0)
    ///
    /// Пример:
    /// ```json
    /// {
    ///   "TemperateForest": 0.6,
    ///   "Grassland": 0.3,
    ///   "Swamp": 0.1
    /// }
    /// ```
    ///
    /// Используется для:
    /// - Определения доступных ресурсов
    /// - Генерации названий (например, "Зелёные холмы" для леса)
    /// - Климатических механик (урожайность, болезни)
    ///
    /// Доля вычисляется как: `количество_пикселей_биома / площадь_провинции`
    pub biomes: HashMap<String, f32>,
}
