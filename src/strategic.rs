// src/strategic.rs
//! Стратегические точки мира
//!
//! Этот модуль идентифицирует географически значимые локации, влияющие на геймплей:
//! - **Порты** — точки морской торговли и высадки десанта
//! - **Устья рек** — естественные гавани с доступом к внутренним водным путям
//! - **Перевалы** — узкие проходы через горные хребты (ключевые точки обороны)
//! - **Проливы** — узкие морские проходы между сушей (контроль над морскими путями)
//!
//! ## Геймплейное значение
//!
//! Стратегические точки формируют "точки интереса" на карте:
//! - **Экономика**: порты и устья дают бонусы к торговле
//! - **Военная тактика**: перевалы и проливы создают естественные узкие места для обороны
//! - **Дипломатия**: контроль над проливами позволяет блокировать морские пути соседей
//! - **Колонизация**: устья рек являются приоритетными точками для основания городов
//!
//! ## Алгоритм обнаружения
//!
//! ### Порты (`Port`)
//! - Условия:
//!   - Провинция является прибрежной (`province.coastal == true`)
//!   - Провинция не содержит значимого речного потока
//! - Геймплей: базовые морские торговые возможности
//!
//! ### Устья рек (`Estuary`)
//! - Условия:
//!   - Провинция является прибрежной
//!   - Провинция содержит пиксели реки (значение > 0 в `RiverMap`)
//!   - Река впадает в море в пределах провинции
//! - Геймплей: повышенные бонусы к торговле (доступ к внутренним водным путям)
//!
//! ### Перевалы (`Pass`)
//! - Условия:
//!   - Провинция является внутренней (`!province.coastal`)
//!   - Провинция содержит горные биомы (`RockyMountain` или `GlacialMountain`)
//!   - Провинция имеет небольшую площадь (< 300 пикселей) — узкий проход
//! - Геймплей: естественные укрепления, бонусы к обороне
//!
//! ### Проливы (`Strait`)
//! - Условия (требует анализа морских провинций):
//!   - Морская провинция окружена сушей с двух сторон
//!   - Ширина провинции мала относительно длины (высокий аспект-рейтио)
//! - Геймплей: контроль над морскими путями, возможность блокады
//! - ⚠️ **В текущей версии не реализовано** — требует анализа формы морских провинций
//!
//! ## Ограничения текущей реализации
//!
//! - **Простой алгоритм**: обнаружение основано на локальных свойствах провинции
//!   (не учитывает глобальную топологию, например, "узкость" пролива)
//! - **Нет иерархии**: все точки одного типа имеют равную значимость
//!   (в будущем можно добавить веса на основе размера/расположения)
//! - **Проливы не реализованы**: требуют сложного анализа формы морских провинций
//!
//! ## Пример использования
//! ```rust
//! let strategic_points = find_strategic_points(
//!     &provinces,
//!     &river_map,
//!     &biome_map,
//!     &pixel_to_id,
//! );
//!
//! // Подсчёт типов точек
//! let ports = strategic_points.iter().filter(|p| matches!(p, StrategicPoint::Port { .. })).count();
//! let estuaries = strategic_points.iter().filter(|p| matches!(p, StrategicPoint::Estuary { .. })).count();
//! let passes = strategic_points.iter().filter(|p| matches!(p, StrategicPoint::Pass { .. })).count();
//! ```

use crate::biome::BiomeMap;
use crate::province::Province;
use crate::rivers::RiverMap;
use serde::Serialize;

/// Тип стратегической точки — географически значимая локация
///
/// Каждая точка привязана к провинции и предоставляет уникальные геймплейные преимущества.
#[derive(Debug, Clone, Serialize)]
pub enum StrategicPoint {
    /// Морской порт — точка морской торговли и высадки
    ///
    /// Условия появления:
    /// - Провинция прибрежная (`coastal == true`)
    /// - Отсутствуют значимые реки в провинции
    ///
    /// Геймплейные эффекты:
    /// - Базовый бонус к морской торговле (+10%)
    /// - Возможность строительства верфи
    /// - Точка высадки десанта
    ///
    /// Примеры в реальном мире: Гамбург, Сингапур (базовый порт)
    Port {
        /// Идентификатор провинции, содержащей порт
        province_id: u32,
    },

    /// Горный перевал — узкий проход через хребет
    ///
    /// Условия появления:
    /// - Провинция внутренняя (`coastal == false`)
    /// - Содержит горные биомы (`RockyMountain` или `GlacialMountain`)
    /// - Малая площадь (< 300 пикселей) — узкий проход
    ///
    /// Геймплейные эффекты:
    /// - Бонус к обороне (+25% к защите)
    /// - Замедление передвижения армий через провинцию
    /// - Естественная линия обороны
    ///
    /// Примеры в реальном мире: Бреннерский перевал, Хайберский перевал
    Pass {
        /// Идентификатор провинции, содержащей перевал
        province_id: u32,
    },

    /// Устье реки — точка впадения реки в море
    ///
    /// Условия появления:
    /// - Провинция прибрежная
    /// - Содержит пиксели реки (значение > 0 в `RiverMap`)
    ///
    /// Геймплейные эффекты:
    /// - Повышенный бонус к торговле (+25%)
    /// - Доступ к внутренним водным путям
    /// - Приоритетная точка для основания городов
    ///
    /// Примеры в реальном мире: Новый Орлеан (устье Миссисипи), Роттердам (устье Рейна)
    Estuary {
        /// Идентификатор провинции, содержащей устье
        province_id: u32,
    },

    /// Морской пролив — узкий проход между сушей
    ///
    /// Условия появления (в будущих версиях):
    /// - Морская провинция с высоким аспект-рейтио (длина >> ширина)
    /// - Окружена сушей с двух сторон
    ///
    /// Геймплейные эффекты (планируемые):
    /// - Контроль над морскими торговыми путями
    /// - Возможность морской блокады
    /// - Стратегическая важность для флота
    ///
    /// Примеры в реальном мире: Гибралтарский пролив, Босфор
    Strait {
        /// Идентификатор провинции, содержащей пролив
        province_id: u32,
    },
}

/// Находит стратегические точки на карте мира
///
/// # Алгоритм
/// 1. **Итерация по провинциям**:
///    - Пропускаем морские провинции (пока не поддерживаем проливы)
///    - Анализируем только сухопутные провинции
///
/// 2. **Анализ пикселей провинции**:
///    - Сканируем все пиксели карты для поиска:
///      - Пикселей реки (`river_map.data[idx] > 0`)
///      - Горных биомов (`RockyMountain`, `GlacialMountain`)
///    - Определяем наличие реки и гор в провинции
///
/// 3. **Классификация точки** (в порядке приоритета):
///    - **Устье**: прибрежная + есть река
///    - **Порт**: прибрежная + нет реки
///    - **Перевал**: внутренняя + есть горы + малая площадь (< 300)
///    - **Пролив**: не реализован в текущей версии
///
/// # Параметры
/// * `provinces` — список всех провинций мира
/// * `river_map` — карта рек для обнаружения речных пикселей
/// * `biome_map` — карта биомов для обнаружения горных биомов
/// * `pixel_to_id` — карта пикселей → `province_id` для привязки пикселей к провинциям
///
/// # Возвращает
/// Вектор `StrategicPoint` с найденными точками. Порядок не гарантируется.
///
/// # Особенности
/// - **Приоритет устьев**: прибрежная провинция с рекой всегда классифицируется как устье,
///   а не как порт (устье ценнее геймплейно)
/// - **Перевалы требуют малой площади**: только узкие горные проходы получают статус перевала
/// - **Проливы не реализованы**: текущая версия возвращает только порты, устья и перевалы
/// - **Детерминированность**: результат зависит только от входных данных
///
/// # Пример
/// ```rust
/// let points = find_strategic_points(&provinces, &river_map, &biome_map, &pixel_to_id);
///
/// // Найти все порты
/// let ports: Vec<u32> = points
///     .iter()
///     .filter_map(|p| match p {
///         StrategicPoint::Port { province_id } => Some(*province_id),
///         _ => None,
///     })
///     .collect();
/// ```
/// Находит стратегические точки мира
///
/// # Алгоритм
/// Для каждой сухопутной провинции:
/// 1. Сканируем все пиксели провинции
/// 2. Проверяем наличие реки (пиксель реки в `river_map`)
/// 3. Проверяем наличие горных биомов
/// 4. Классифицируем точку по приоритету:
///    - Устье (прибрежная + река) > Порт (прибрежная) > Перевал (горная)
#[must_use]
pub fn find_strategic_points(
    provinces: &[Province],
    river_map: &RiverMap,
    biome_map: &BiomeMap,
    pixel_to_id: &[u32],
) -> Vec<StrategicPoint> {
    let mut points = Vec::new();
    let width = biome_map.width as usize;
    let height = biome_map.height as usize;

    // Анализируем каждую провинцию
    for province in provinces {
        // Пропускаем морские провинции (проливы пока не реализованы)
        if !province.is_land {
            continue;
        }

        let mut has_river = false;
        let mut has_mountain = false;

        // Сканируем все пиксели провинции
        for y in 0..height {
            for x in 0..width {
                let idx = y * width + x;
                if pixel_to_id[idx] != province.id {
                    continue;
                }

                // Проверка наличия реки
                // data теперь RGB: каждый пиксель — 3 байта (R, G, B)
                let pixel_idx = idx * 3;
                let is_river = river_map.data[pixel_idx] > 0
                    || river_map.data[pixel_idx + 1] > 0
                    || river_map.data[pixel_idx + 2] > 0;

                if is_river {
                    has_river = true;
                }

                // Проверка горных биомов
                match biome_map.data[idx] {
                    crate::biome::Biome::RockyMountain | crate::biome::Biome::GlacialMountain => {
                        has_mountain = true;
                    }
                    _ => {}
                }
            }
        }

        // Классификация стратегической точки (в порядке приоритета)
        if province.coastal && has_river {
            // Устье: прибрежная провинция с рекой (наиболее ценная точка)
            points.push(StrategicPoint::Estuary {
                province_id: province.id,
            });
        } else if province.coastal {
            // Порт: прибрежная провинция без реки
            points.push(StrategicPoint::Port {
                province_id: province.id,
            });
        } else if has_mountain && province.area < 300 {
            // Перевал: внутренняя горная провинция малой площади (узкий проход)
            points.push(StrategicPoint::Pass {
                province_id: province.id,
            });
        }
        // Проливы: требуют анализа морских провинций — не реализованы в текущей версии
    }

    points
}
